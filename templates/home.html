<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Forecast</title>
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <!-- Custom CSS -->
    <style>
        body {
            background-color: #1D2951; /* light navy blue */
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            color: #3378b4;
        }
    </style>
</head>
<body>
    <div class="jumbotron" style="background-image: url('{{ url_for('static', filename='cloud-banner.jpg') }}'); background-size: cover; height: 140px; margin-bottom:12px;">
  <div class="container h-100 d-flex align-items-center">
    <div class="d-flex align-items-center w-100 justify-content-center">
      <img src="{{ url_for('static', filename='NOAA-logo.png') }}" 
           alt="NOAA logo" 
           style="height: 100px; width: 100px; border-radius: 50%; margin-right: 20px;">
      <h1 class="mb-0 font-weight-bolder" style="color: rgb(29, 63, 82);">Forecasting Using Linear Regression</h1>
    </div>
  </div>
</div>


    <div class="container">
        <div class="row align-items-start">
        <!-- Instructions Sidebar -->
        <div class="col-md-4 mb-4">
            <div class="card bg-light mb-3">
                <div class="card-header">Instructions:</div>
                <div class="card-body">
                    <p class="card-text" style="font-size: 13px;">
                        1. Prepare your CSV file with weather data.<br>
                        2. Go to <a href="https://www.ncei.noaa.gov/cdo-web/results" target="_blank">https://www.ncei.noaa.gov/cdo-web/results</a> and search for a nearby station to your location by city. The date range should be any date in 2000 through current, and choose "Daily Summaries" dropdown.<br>
                        For the best results find a station that has the highest coverage and earliest data collection period<br>
                        3. Click add to cart and go to view cart in the top right corner. <br>
                        4. Make sure Custom GHCN-Daily CSV is selected and scroll down to select a date range. <br>
                        5. The date range should start anytime in the year 2000 and end on today's date. <br>
                        If your selected weather station does not have data from that far back choose the the earliest available start date. <br>
                        6. Click continue and scroll to where it says "Select data types for custom output". <br>
                        7. Click "Select All" and then click "Continue". <br>
                        Here you can see variables you can forecast. You want to make sure your station has many variables to choose from. <br>
                        Some stations lack temperature, precipitation, etc., so make sure to select a station that has the desired variables. <br>
                        8. Enter your email address and click "Submit Order".<br>
                        You should instantly see a order request email and the file should arrive in less than five minutes. <br>
                        9. When the CSV arrives, click "Download" and store it. <br>
                        10. Now upload it here and select the desired dates and desired weather element to predict. <br>
                        11. Note that the date range cannot be more than a year in the future. <br>
                        12. Click "Upload & Forecast" to get the predicted forecast. <br>
                    </p>
                </div>
                </div>
            </div>
            
            <!-- Form -->
              <div class="col-md-8 d-flex justify-content-center">
                <div class="header center" style="margin-top:-12px; width:100%;">
                    <h1 style="color: white;">Weather Forecast</h1>
                    <p style="color:#458bc9">Upload your CSV file to get a weather forecast based on your data.</p>
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data" class="mt-4">
                            <div class="form-group text-center">
                                <label for="fileUpload" style="color: white">Select your CSV file:</label>
                                <div style="display: grid; grid-template-columns: 1fr auto 1fr; justify-items: center; width:100%">
                                    <div></div>
                                    <div>
                                        <input type="file" id="fileUpload" name="file" style="display: none;" class="hidden" onchange="handleFileSelect(event)" onclick="clearForm()">
                                        <button type="button" onclick="document.getElementById('fileUpload').click()">Choose File</button>
                                    </div>
                                    <div style="text-align: left; white-space: nowrap; overflow: hidden; width: 200px; text-overflow: ellipsis; margin-left: 20px;">
                                        <label for="fileUpload" id="fileUploadLabel" style="color: rgb(255, 255, 255); white-space: nowrap; overflow: hidden; width: 200px; text-overflow: ellipsis; display: inline-block;">No file chosen</label>
                                    </div>
                                </div>
                                <div id="dateInputs" style="display: none;">
                                    <div class="form-group text-center">
                                        <div class="d-flex justify-content-around" style="width: 400px; margin: auto;">
                                            <div>
                                                <label for="startDate" style="color:white">Start Date:</label>
                                                <input type="date" id="startDate" name="startDate" class="form-control-file" style="width: 150px;" max="{{ max_date }}">
                                            </div>
                                            <div style="align-self: center; margin-top: 25px;"> <!-- New div for 'to' -->
                                                <span style="color:white; font-size: 1.2em;">to</span>
                                            </div>
                                            <div>
                                                <label for="endDate" style="color:white">End Date:</label>
                                                <input type="date" id="endDate" name="endDate" class="form-control-file" style="width: 150px;" max="{{ max_date }}">
                                            </div>
                                            
                                        </div>
                                    <div>
                                    </div>
                                    </div>
                                        <select id="columnSelect" style="display: none;" onchange="updateSelectedVariable(this.value);">
                                            {% for column in desired_columns %}
                                                <option value="{{ column }}">{{ column }}</option>
                                            {% endfor %}
                                        </select>
                                        <input type="hidden" id="selectedVariable" name="selectedVariable">
                                    </div>
                                    <input type="hidden" id="forecastClicked" name="forecastClicked" value="false">
                                    <div id="uploadButtonDiv" style="display: none; text-align: center; margin-top: 20px;">
                                        <input type="button" value="Upload & Forecast" class="btn btn-primary" onclick="submitForecast()">
                                    </div>
                                    <div id="tableWrapper">
                                        {% if output_table %}
                                            <div id="tableContainer">
                                                <h2>PREDICTED FORECAST FOR {{ station_name }}</h2>
                                                {{ output_table | safe }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <style>
                                        /* ... existing CSS ... */
                                        #tableWrapper {
                                            border: 1px solid black;
                                            display: inline-block; 
                                            position: absolute; /* This allows you to position the element anywhere on the page */
                                            /* This makes the div only as wide as its contents */
                                            top: -50px; /* This positions the element at the top of the page */
                                            right: -400px;
                                        }
                                        #tableContainer {
                                            background-color: white;
                                            color: black;
                                            text-align: center; 
                                            
                                        }
                                        #tableContainer th, #tableContainer td {
                                            padding: 2px;
                                            word-wrap: break-word; /* This will make the text wrap inside the cell */
                                            max-width: 175px; /* Half of the h2 max-width */
                                            text-align: center;
                                            vertical-align: middle; /* This centers the content vertically */
                                        }
                                        #tableContainer h2 {
                                            font-size: 15px;
                                            overflow-wrap: normal; /* Prevents the browser from breaking words at arbitrary points */
                                            word-break: normal; /* Prevents the browser from breaking words at arbitrary points */
                                            white-space: pre-wrap;
                                            text-align: center; /* Center the text */
                                            margin: 0; /* Remove the default margin */
                                            max-width: 350px; /* This sets a maximum width for the h2 elements */
                                        }
                                        #tableContainer table {
                                            text-align: center;
                                            table-layout: fixed; /* This makes the table respect the width of the cells */
                                            width: 350px; /* This makes the table take the full width of its container */
                                        }
                                    </style>
                                        <div>
                                        
                                        </div>
                                        <div>

                                        </div>
                                </div>
                            </div>
                        </form>
                        
                    </div>
                </div>
        </div>
    </div>      

<script>
    var fileUploaded = false;
    function clearForm() {
        if (fileUploaded) {
        // Refresh the page
        location.reload();
    }
}
    document.getElementById('fileUpload').addEventListener('change', function(e) {
    if (fileUploaded) {
        // Reset form fields and variables related to the previous file upload
        clearForm();
    }

    var file = e.target.files[0];

});
function clearForm() {
    if (fileUploaded) {
        // Reset form fields and variables related to the previous file upload
        document.getElementById('fileUploadLabel').textContent = 'No file chosen';
        document.getElementById('dateInputs').style.display = 'none';
        document.getElementById('uploadButtonDiv').style.display = 'none';
        var columnSelect = document.getElementById('columnSelect');
        while (columnSelect.firstChild) {
            columnSelect.removeChild(columnSelect.firstChild);
        }

        // Clear the output table
        var outputTable = document.getElementById('outputTable');
        while (outputTable.firstChild) {
            outputTable.removeChild(outputTable.firstChild);
        }

        fileUploaded = false;
    }
}
    function submitForecast() {
    var form = document.querySelector('form');
    form.elements.namedItem("forecastClicked").value = "true";
    form.submit();
}
    function convertDate(inputFormat) {
        var date = new Date(inputFormat);
        return isNaN(date.getTime()) ? null : date;
    }
    

    var maxDate = null;

    document.getElementById('fileUpload').addEventListener('change', function(e) {
        var file = e.target.files[0];
        
        Papa.parse(file, {
        header: true,
        complete: function(results) {
            var columnSelect = document.getElementById('columnSelect');
            // Clear any existing options
            while (columnSelect.firstChild) {
                columnSelect.removeChild(columnSelect.firstChild);
            }
            // Add an option for each column
             var columns = results.meta.fields;
             var columnMapping = {
            'PRCP': 'Precipitation',
            'SNOW': 'Snowfall',
            'TAVG': 'Average Temperature',
            'TMAX': 'Maximum Temperature',
            'TMIN': 'Minimum Temperature',
            'AWND': 'Average Wind Speed'
        };  // Add your desired columns here
    for (var i = 0; i < columns.length; i++) {
        if (columnMapping.hasOwnProperty(columns[i])) {
            var option = document.createElement('option');
            option.value = columns[i];
            option.text = columnMapping[columns[i]];
            columnSelect.appendChild(option);
    }
}
        }
    });
    

        var reader = new FileReader();
        reader.onload = function(e) {
            var contents = e.target.result;
            var lines = contents.split('\n');
            var dates = lines.map(function(line) {
                var columns = line.split(',');
                var date = convertDate(columns[3]);  // Assuming the date is in the fourth column
                return date;
            });
            dates = dates.filter(date => date !== null);  // Remove null dates
            maxDate = new Date(Math.max.apply(null, dates));
            console.log('Max Date:', maxDate);
            checkDates();  // Call checkDates after maxDate has been updated
        };
        reader.readAsText(file);
    });


function checkDates() {
    var startDateInput = document.getElementById('startDate');
    var endDateInput = document.getElementById('endDate');
    console.log('Start Date Input:', startDateInput.value);
    console.log('End Date Input:', endDateInput.value);
    console.log('Max Date:', maxDate);
    var startDate = startDateInput.value ? new Date(new Date(startDateInput.value).setHours(0, 0, 0, 0)) : null;
    var endDate = endDateInput.value ? new Date(new Date(endDateInput.value).setHours(0, 0, 0, 0)) : null;
    console.log('Start Date:', startDate);
    console.log('End Date:', endDate);
    var columnSelect = document.getElementById('columnSelect');
    if (startDate && endDate) {
        var maxDatePlusOneYear = new Date(maxDate.setFullYear(maxDate.getFullYear() + 1));
        if (startDate > maxDatePlusOneYear || endDate > maxDatePlusOneYear) {
            alert('Start or end date cannot be more than one year after the last date in the CSV.');
            columnSelect.style.display = 'none';
        } else if (startDate > endDate) {
            alert('Start date must come before end date.');
            columnSelect.style.display = 'none';
        } else {
            columnSelect.style.display = '';  // Set display back to its original value
        }
    } else {
        columnSelect.style.display = 'none';
    }
};

document.getElementById('startDate').onchange = checkDates;
document.getElementById('endDate').onchange = checkDates;
</script>
                    
            <!-- Include Bootstrap JS -->
            <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>>
            <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
            <script>
                window.onload = function() {
                    document.getElementById('fileUpload').addEventListener('change', function() {
                        var buttonWidth = document.getElementById('chooseFileButton').offsetWidth;
                        document.getElementById('fileUploadLabel').parentElement.style.left = (50 + buttonWidth / 2) + 'px';
                    });
            
                    document.getElementById('fileUpload').addEventListener('change', function(e) {
                        var file = e.target.files[0];
                        if (file.type != 'text/csv') {
                            alert('Uploaded file is not a CSV. Please refer to instructions.');
                            e.target.value = '';  // Clear the file input
                            document.getElementById('fileUploadLabel').textContent = 'No file chosen';
                            return;
                        }
            
                        var fileName = file.name;
                        if (fileName.length > 20) { // adjust the number as needed
                            fileName = fileName.substring(0, 17) + '...';
                        }
                        document.getElementById('fileUploadLabel').textContent = fileName;
            
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            console.log('File loaded.');
                            fileUploaded = true;
                            var contents = e.target.result;
                            console.log('File contents:', contents);
                            var lines = contents.split('\n');
                            var firstLine = lines[0];
                            console.log('First line:', firstLine);
                            var separator = firstLine.includes('\t') ? '\t' : ',';
                            var columns = firstLine.split(separator).map(column => column.replace(/"/g, '').trim().toUpperCase());
                            console.log('Columns:', columns);
                            var dateColumnIndex = columns.indexOf('DATE');
                            console.log('Date column index:', dateColumnIndex);
                            if (dateColumnIndex == -1) {
                                console.log('Date column not found.');
                                alert('CSV does not contain a "DATE" column.');
                                document.getElementById('fileUpload').value = '';  // Clear the file input
                                document.getElementById('fileUploadLabel').textContent = 'No file chosen';
                            } else {
                                console.log('Date column found.');
                                // If the CSV contains a "DATE" column, display the date selection fields
                                // Replace 'dateInputs' with the actual ID of your date selection fields
                                document.getElementById('dateInputs').style.display = 'block';
                            }
                        };
                        reader.readAsText(file);
                    });
                    var columnSelect = document.getElementById('columnSelect');
                    var uploadButtonDiv = document.getElementById('uploadButtonDiv');

                   // Show the div containing the button when an option is selected from the dropdown
                    columnSelect.addEventListener('change', function() {
                    uploadButtonDiv.style.display = 'block';
            });  
                };
                </script>
    <script>
        columnSelect.addEventListener('change', function() {
    updateSelectedVariable(this.value);
});
        function updateSelectedVariable(value) {
                document.getElementById('selectedVariable').value = value;
                console.log('Selected variable: ' + value);
        }
        
    </script>

    <!-- ======= SPACING/POSITIONING OVERRIDES ONLY (no functionality changes) ======= -->
    <style>
      /* Make the banner content flow normally */
      .jumbotron h1 { top: 0 !important; }
      .jumbotron .col-md-4 img { position: static !important; margin: -60px 0 0 0 !important; }

      /* Let the instructions card live in the normal flow and fill its column */
      .card.bg-light.mb-3 {
        position: static !important;
        left: auto !important;
        top: auto !important;
        width: 100% !important;
      }

      /* Make the main header block flow normally instead of absolute */
      .header.center {
        position: static !important;
        top: auto !important;
        margin-top: 1rem !important;
        width: 100%;
      }

      /* Keep the results area within the layout and allow horizontal scroll on small screens */
      #tableWrapper {
        position: static !important;
        top: auto !important;
        right: auto !important;
        display: block !important;
        width: 100% !important;
        margin-top: 1rem !important;
        overflow-x: auto !important;
        border: none !important; /* optional: remove hard border that looked misaligned */
      }
      #tableContainer { padding: 12px !important; }
      #tableContainer table { width: 100% !important; table-layout: fixed !important; }
      #tableContainer h2 { max-width: 100% !important; }

      /* Tweak the small grid around the file picker so it wraps gracefully */
      @media (max-width: 576px) {
        .d-flex.justify-content-around { flex-wrap: wrap; }
      }

      /* Give the whole page some breathing room on very wide screens */
      @media (min-width: 1200px) {
        .container { max-width: 1100px; }
      }
    </style>
</body>
</html>
